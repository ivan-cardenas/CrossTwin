{% extends 'base.html' %}
{% load static %}
{% block title %}Urban Twin - Map View{% endblock %}

{% block extra_css %}
<link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/mainMap.css' %}" />
{% endblock %}

{% block extra_js %}
<script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>
<script src="{% static 'js/mainMap.js' %}"></script>
{% endblock %}

{% block content %}
<div class="app-shell">
  <div class="map-wrapper">
    <div id="map"></div>

    <!-- LEFT TOOLBAR -->
    <div class="toolbar" id="toolbar">
      <button class="tool-button active" data-tool="overview">
        <span>ğŸ‘ï¸</span>
        <div class="tool-tooltip">Overview</div>
      </button>
      <button class="tool-button" data-tool="common">
        <span>ğŸ“‘</span>
        <div class="tool-tooltip">Common Data</div>
      </button>

      <button class="tool-button" data-tool="builtup">
        <span>ğŸ—ï¸</span>
        <div class="tool-tooltip">Built-up</div>
      </button>
      <button class="tool-button" data-tool="Housing">
        <span>ğŸ˜ï¸</span>
        <div class="tool-tooltip">Housing</div>
      </button>

      <button class="tool-button" data-tool="energy">
        <span>âš¡</span>
        <div class="tool-tooltip">Energy</div>
      </button>

      <button class="tool-button" data-tool="temperature">
        <span>ğŸŒ¡ï¸</span>
        <div class="tool-tooltip">Heat</div>
      </button>
      <button class="tool-button" data-tool="green">
        <span>ğŸŒ³</span>
        <div class="tool-tooltip">Green</div>
      </button>
      <button class="tool-button" data-tool="water">
        <span>ğŸ’§</span>
        <div class="tool-tooltip">Water</div>
      </button>
      <button class="tool-button" data-tool="groundwater">
        <span>ğŸš°</span>
        <div class="tool-tooltip">Groundwater</div>
      </button>
      {% comment %} <button class="tool-button" data-tool="satellite">
        <span>ğŸ›°ï¸</span>
        <div class="tool-tooltip">Satellite</div>
      </button> {% endcomment %}
    </div>

    <!-- ONBOARDING HINT -->
    <div class="onboarding-hint" id="onboarding-hint">
      <strong>Start here</strong>
      <p>Use the icons on the left to explore thematic layers. Click ğŸ“‘ to manage all database layers.</p>
    </div>

    <!-- LAYERS PANEL -->
    <div class="layers-panel" id="layers-panel">
      <div class="layers-panel-header">
        <div class="layers-panel-title">
          <i class="bi bi-layers"></i> Database Layers
        </div>
        <button class="layers-panel-close" id="layers-panel-close">âœ•</button>
      </div>
      
      <div class="layers-panel-body" id="layer-list">
        <div class="loading-layers">
          <div class="loading-spinner"></div>
          <p>Loading layers...</p>
        </div>
      </div>
      
      <div class="basemap-selector">
        <label for="basemap-select">Basemap</label>
        <select id="basemap-select">
          <option value="light" selected>Light</option>
          <option value="dark">Dark</option>
          <option value="streets">Streets</option>
          <option value="satellite">Satellite</option>
          <option value="outdoors">Outdoors</option>
        </select>
      </div>
      
      <div class="layers-panel-footer">
        <button class="layers-action-btn" id="btn-select-all" title="Select All">
          <i class="bi bi-check-all"></i> All
        </button>
        <button class="layers-action-btn" id="btn-select-none" title="Deselect All">
          <i class="bi bi-x-lg"></i> None
        </button>
        <button class="layers-action-btn" id="btn-fit-all" title="Fit to Visible">
          <i class="bi bi-arrows-fullscreen"></i> Fit
        </button>
      </div>
    </div>

    <!-- SIDE PANEL (Info/Dashboard) -->
    <div class="side-panel" id="side-panel">
      <div class="side-panel-header">
        <div class="side-panel-title" id="panel-title">OVERVIEW</div>
        <button class="side-panel-close" id="panel-close">âœ•</button>
      </div>
      <div class="side-panel-body" id="panel-body">
        <p>Use the tool icons on the left to switch between thematic layers.</p>
        <p>Click the ğŸ“‘ Layers button to manage all database layers individually.</p>
      </div>
      <div class="side-panel-tagline">
        CROSSTWIN Â· URBAN DIGITAL TWIN
      </div>
    </div>

    <!-- GROUNDWATER LEGEND -->
    <div id="legend-groundwater" class="map-legend" style="display: none;">
      <div class="legend-title">Groundwater (GHG)</div>
      <img id="legend-img"
        src="https://service.pdok.nl/bzk/bro-grondwaterspiegeldiepte/wms/v2_0/legend/bro-grondwaterspiegeldieptemetingen-GHG/mediaan.png"
        alt="GHG legend" />
    </div>

    <!-- MAP LOADER -->
    <div class="map-loader" id="map-loader">
      <div class="loading-spinner"></div>
      <span>Loading features...</span>
    </div>

    <!-- BOTTOM BAR -->
    <div class="bottom-bar">
      <div class="bottom-left">
        <div class="camera-tools">
          <button class="camera-btn" id="btn-tilt" title="Toggle 3D Tilt">â¤¢</button>
          <button class="camera-btn" id="btn-reset" title="Reset View">âŸ³</button>
        </div>

        <div class="indicator-pill" data-indicator="layers">
          <div class="indicator-icon">ğŸ“</div>
          <div class="indicator-meta">
            <span class="indicator-label">Layers</span>
            <span class="indicator-value" id="layers-count">0</span>
          </div>
        </div>

        <div class="indicator-pill" data-indicator="features">
          <div class="indicator-icon">ğŸ”·</div>
          <div class="indicator-meta">
            <span class="indicator-label">Features</span>
            <span class="indicator-value" id="features-count">0</span>
          </div>
        </div>

        <div class="indicator-pill" data-indicator="visible">
          <div class="indicator-icon">ğŸ‘ï¸</div>
          <div class="indicator-meta">
            <span class="indicator-label">Visible</span>
            <span class="indicator-value" id="visible-count">0</span>
          </div>
        </div>
      </div>

      <div class="city-name">{{ city_name|default:"Enschede" }}</div>

      <div class="bottom-right">
        <button class="mode-btn" id="btn-dashboard">
          <span>ğŸ“Š</span> Dashboard
        </button>
        <button class="mode-btn" id="btn-scenarios">
          <span>ğŸ§©</span> Scenarios
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize with Django context
  window.CONFIG = {
    mapboxToken: "{{ mapbox_access_token }}",
    layersApiUrl: "/map/api/layers/",
    initialCenter: [6.895, 52.219],  // Enschede
    initialZoom: 13,
    initialPitch: 60,
    initialBearing: -35
  };
  
  // Initialize the Urban Twin map
  document.addEventListener('DOMContentLoaded', () => {
    initializeUrbanTwinMap(window.CONFIG);
  });
</script>
{% endblock content %}